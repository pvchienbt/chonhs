<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc sinh may m·∫Øn</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MediaPipe - Hand Tracking -->
    <script async src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
    <!-- Th∆∞ vi·ªán x·ª≠ l√Ω File -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #87CEEB; }
        #game-canvas { display: block; width: 100vw; height: 100vh; touch-action: none; }
        #camera-container {
            position: absolute; bottom: 20px; right: 20px; width: 180px; height: 135px;
            border-radius: 12px; overflow: hidden; border: 3px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 20; background: black;
        }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #menu-btn {
            position: absolute; top: 20px; left: 20px; z-index: 40; background: white;
            border-radius: 50%; width: 48px; height: 48px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        #ui-panel {
            position: absolute; top: 80px; left: 20px; background: rgba(255, 255, 255, 0.98);
            padding: 20px; border-radius: 16px; width: 340px; z-index: 30;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-height: 80vh; overflow-y: auto;
            transition: opacity 0.3s;
        }
        .panel-hidden { opacity: 0; pointer-events: none; }
        #loading { position: fixed; inset: 0; background: #f0f9ff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="text-6xl mb-4 animate-bounce">üöú</div>
        <h1 class="text-2xl font-bold text-blue-700">H·ªçc Sinh May M·∫Øn</h1>
        <p id="loading-status" class="text-gray-500 mt-2">ƒêang thi·∫øt l·∫≠p h·ªá th·ªëng...</p>
    </div>

    <div id="menu-btn">‚öôÔ∏è</div>

    <div id="ui-panel" class="panel-hidden">
        <h2 class="text-xl font-bold text-green-700 mb-4">üåª Qu·∫£n l√Ω l·ªõp h·ªçc</h2>
        <div class="space-y-4">
            <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                <label class="block text-xs font-bold text-blue-800 mb-2 uppercase">L·ªõp hi·ªán t·∫°i:</label>
                <div class="flex gap-2">
                    <select id="classSelector" class="flex-1 p-2 rounded-lg border bg-white text-sm outline-none"></select>
                    <button id="deleteClassBtn" class="bg-red-50 text-red-600 p-2 rounded-lg border border-red-200">üóëÔ∏è</button>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="newClassName" class="flex-1 p-2 border rounded-lg text-sm" placeholder="T√™n l·ªõp m·ªõi...">
                <button id="addClassBtn" class="bg-green-600 text-white px-4 rounded-lg text-sm font-bold">Th√™m</button>
            </div>
            <hr>
            <div class="grid grid-cols-2 gap-2">
                <label class="cursor-pointer bg-blue-100 text-blue-700 p-2 rounded-lg text-xs text-center font-bold">
                    üìÇ T·∫£i File
                    <input type="file" id="fileInput" accept=".txt,.xlsx,.xls,.docx" class="hidden">
                </label>
                <button id="resetNamesBtn" class="bg-gray-100 text-gray-700 p-2 rounded-lg text-xs font-bold">üîÑ X√≥a t√™n</button>
            </div>
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                <label class="block text-xs font-bold text-gray-600 mb-1">D√≤ng h·ªçc sinh:</label>
                <textarea id="manualInput" rows="4" class="w-full p-2 text-sm rounded-lg border mb-2 outline-none"></textarea>
                <button id="manualBtn" class="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-bold">‚úÖ C·∫≠p nh·∫≠t</button>
            </div>
            <button id="saveCloudBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow-lg">‚òÅÔ∏è L∆ØU ƒê√ÅM M√ÇY</button>
            <p id="auth-status" class="text-[10px] text-center text-gray-400">Ch∆∞a k·∫øt n·ªëi Cloud</p>
        </div>
    </div>

    <div id="status-container" class="absolute top-10 left-1/2 -translate-x-1/2 z-20 pointer-events-none">
        <div id="status-text" class="text-3xl font-black text-white px-8 py-3 rounded-full bg-black/40 backdrop-blur-lg border border-white/20 shadow-2xl">
            S·∫µn s√†ng!
        </div>
    </div>

    <div id="camera-container">
        <video id="camera-feed" autoplay playsinline muted></video>
    </div>

    <canvas id="game-canvas"></canvas>

    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, doc, setDoc, getDoc } from 'firebase/firestore';

        /* H∆Ø·ªöNG D·∫™N: 
           N·∫øu b·∫°n nh√∫ng v√†o Notion, h√£y thay th·∫ø 'null' ·ªü d∆∞·ªõi b·∫±ng config c·ªßa b·∫°n 
           t·ª´ Firebase Console (Settings -> Your Apps -> Web App).
        */
        const myFirebaseConfig = {
            apiKey: "AIza...", 
            authDomain: "your-app.firebaseapp.com",
            projectId: "your-app",
            storageBucket: "your-app.appspot.com",
            messagingSenderId: "...",
            appId: "..."
        };

        // --- KH·ªûI T·∫†O FIREBASE ---
        let db, auth, user = null;
        let finalAppId = "notion-app";

        try {
            // ∆Øu ti√™n d√πng config c√° nh√¢n n·∫øu c√≥, kh√¥ng th√¨ d√πng config h·ªá th·ªëng
            const config = myFirebaseConfig.apiKey !== "AIza..." ? myFirebaseConfig : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);
            finalAppId = typeof __app_id !== 'undefined' ? __app_id : 'notion-user-app';
            
            if (config) {
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.warn("Firebase Init Fail:", e); }

        // --- TR·∫†NG TH√ÅI ---
        const ANIMAL_TYPES = ['pig', 'chicken', 'frog', 'bear', 'cat', 'panda'];
        const state = {
            classLists: { "L·ªõp 1": ["H·ªçc sinh 1", "H·ªçc sinh 2"] },
            currentClass: "L·ªõp 1",
            names: [],
            animals: [],
            mode: 'IDLE',
            cameraActive: false
        };

        let canvas, ctx, width, height, handLandmarker, video;

        // --- V·∫º H√åNH ---
        function drawCircle(ctx, x, y, r, color) { ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fillStyle = color; ctx.fill(); }
        function drawOval(ctx, x, y, w, h, color) { ctx.beginPath(); ctx.ellipse(x, y, w, h, 0, 0, Math.PI * 2); ctx.fillStyle = color; ctx.fill(); }

        class Animal {
            constructor(name, index) {
                this.name = name;
                this.type = ANIMAL_TYPES[index % ANIMAL_TYPES.length];
                this.x = Math.random() * window.innerWidth;
                this.y = Math.random() * window.innerHeight;
                this.targetX = this.x; this.targetY = this.y;
                this.size = 50; this.targetSize = 50;
            }
            update() {
                this.x += (this.targetX - this.x) * 0.1;
                this.y += (this.targetY - this.y) * 0.1;
                this.size += (this.targetSize - this.size) * 0.1;
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y);
                drawCircle(ctx, 0, 0, this.size*0.8, '#FFF'); // Simplified
                ctx.fillStyle = '#5D4037'; ctx.fillRect(-40, 40, 80, 25);
                ctx.fillStyle = '#FFF'; ctx.font = "bold 12px Arial"; ctx.textAlign="center";
                ctx.fillText(this.name, 0, 58);
                ctx.restore();
            }
        }

        // --- LOGIC ---
        function updateUI() {
            const sel = document.getElementById('classSelector');
            if(!sel) return;
            sel.innerHTML = '';
            Object.keys(state.classLists).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.innerText = c;
                opt.selected = (c === state.currentClass);
                sel.appendChild(opt);
            });
            document.getElementById('manualInput').value = state.classLists[state.currentClass].join('\n');
        }

        async function saveToCloud(notify) {
            if (!user || !db) { alert("B·∫°n c·∫ßn c·∫•u h√¨nh Firebase API Key trong m√£ ngu·ªìn ƒë·ªÉ d√πng t√≠nh nƒÉng n√†y!"); return; }
            try {
                const docRef = doc(db, 'artifacts', finalAppId, 'users', user.uid, 'settings', 'classConfig');
                await setDoc(docRef, { classLists: state.classLists, currentClass: state.currentClass });
                if (notify) alert("ƒê√£ l∆∞u!");
            } catch (e) { console.error(e); }
        }

        async function loadFromCloud() {
            if (!user || !db) return;
            const docRef = doc(db, 'artifacts', finalAppId, 'users', user.uid, 'settings', 'classConfig');
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const data = snap.data();
                state.classLists = data.classLists;
                state.currentClass = data.currentClass;
                state.names = [...state.classLists[state.currentClass]];
                updateUI();
                resetGame();
            }
        }

        function resetGame() {
            state.animals = state.classLists[state.currentClass].map((n, i) => new Animal(n, i));
            const count = state.animals.length;
            const cols = Math.ceil(Math.sqrt(count));
            state.animals.forEach((a, i) => {
                a.targetX = (i % cols + 0.5) * (width / cols);
                a.targetY = (Math.floor(i / cols) + 0.5) * (height / Math.ceil(count/cols));
            });
        }

        async function setupVision() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task` },
                    runningMode: "VIDEO", numHands: 1
                });
                video = document.getElementById("camera-feed");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                state.cameraActive = true;
            } catch (e) { document.getElementById('status-text').innerText = "Kh√¥ng c√≥ Camera!"; }
        }

        function gameLoop() {
            ctx.clearRect(0,0,width,height);
            ctx.fillStyle = "#87CEEB"; ctx.fillRect(0,0,width,height);
            state.animals.forEach(a => { a.update(); a.draw(ctx); });
            requestAnimationFrame(gameLoop);
        }

        window.onload = async () => {
            canvas = document.getElementById('game-canvas');
            ctx = canvas.getContext('2d');
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;

            document.getElementById('menu-btn').onclick = () => document.getElementById('ui-panel').classList.toggle('panel-hidden');
            document.getElementById('saveCloudBtn').onclick = () => saveToCloud(true);
            document.getElementById('manualBtn').onclick = () => {
                const lines = document.getElementById('manualInput').value.split('\n').filter(l => l.trim());
                state.classLists[state.currentClass] = lines;
                resetGame();
            };

            if (auth) {
                onAuthStateChanged(auth, u => {
                    user = u;
                    document.getElementById('auth-status').innerText = u ? "ƒê√£ k·∫øt n·ªëi Cloud (" + u.uid.substring(0,6) + ")" : "L·ªói k·∫øt n·ªëi";
                    if(u) loadFromCloud();
                });
                signInAnonymously(auth);
            }

            updateUI();
            resetGame();
            await setupVision();
            document.getElementById('loading').style.display = 'none';
            gameLoop();
        };
    </script>
</body>
</html>